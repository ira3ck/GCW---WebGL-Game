<!DOCTYPE html>
<html>

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
		integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
		integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
		crossorigin="anonymous"></script>
	<link rel="shortcut icon" href="img/icono.png" />
	<title>Rey Pide</title>
	<link rel="stylesheet" href="css/style.css">
	<style>
		body {
			margin: 0;
		}

		#info {
			position: absolute;
			top: 10px;
			width: 100%;
			text-align: center;
			z-index: 100;
			display: block;
			color: aliceblue;
		}

		.text {
			display: inline-block;
		}
	</style>
</head>

<body>
	<script src="js/three.js"></script>
	<script type="text/javascript" src="js/libs/three/MTLLoader.js"></script>
	<script type="text/javascript" src="js/libs/three/OBJLoader.js"></script>
	<script src="js/scripts.js"></script>
	<script type="text/javascript">
		var scene;
		var camera;
		var renderer;
		var controls;
		var objects = [];
		var clock;
		var deltaTime;
		var keys = {};
		var cube, cube2;
		var camMove;
		var facing1Prev, facing2Prev;
		var posT;
		var xAxis, zAxis;

		$(document).ready(function () {
			setupScene();
			document.addEventListener('keydown', onKeyDown);
			document.addEventListener('keyup', onKeyUp);

			render();
		});

		function loadOBJWithMTL(path, objFile, mtlFile, onLoadCallback) {
			var mtlLoader = new THREE.MTLLoader();
			mtlLoader.setPath(path);
			mtlLoader.load(mtlFile, (materials) => {

				var objLoader = new THREE.OBJLoader();
				objLoader.setMaterials(materials);
				objLoader.setPath(path);
				objLoader.load(objFile, (object) => {
					onLoadCallback(object);
				});

			});
		}

		function onKeyDown(event) {
			keys[String.fromCharCode(event.keyCode)] = true;
		}
		function onKeyUp(event) {
			keys[String.fromCharCode(event.keyCode)] = false;
		}

		window.addEventListener('resize', onWindowResize);

		function onWindowResize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize(window.innerWidth, window.innerHeight);

		}

		function render() {
			requestAnimationFrame(render);
			deltaTime = clock.getDelta();
			var moveF1 = false;
			var moveS1 = false;

			var yaw = 0;
			var forward = 0;
			if (keys["A"]) {
				yaw = 5;
				moveS1 = true;
			} else if (keys["D"]) {
				yaw = -5;
				moveS1 = true;
			}
			if (keys["W"]) {
				forward = -5;
				moveF1=true;
			} else if (keys["S"]) {
				forward = 5;
				moveF1=true;
			}
			var yaw2 = 0;
			var forward2 = 0;
			if (keys["J"]) {
				yaw2 = 5;
			} else if (keys["L"]) {
				yaw2 = -5;
			}
			if (keys["I"]) {
				forward2 = -5;
			} else if (keys["K"]) {
				forward2 = 5;
			}

			angle = cube.position.angleTo(facing1Prev);
			var orientation = cube.position.x * facing1Prev.z - cube.position.z * facing1Prev.x;
			if (orientation > 0) angle = 2 * Math.PI - angle;
			cube.rotation.y = angle;
			//cube.rotateY(angle);
			//cube.translateOnAxis(zAxis, -forward * deltaTime);
			//cube.translateOnAxis(xAxis, yaw * deltaTime);
			if(moveF1)
			cube.position.z += -forward * deltaTime;
			if(moveS1)
			cube.position.x += yaw * deltaTime;

			cube2.translateZ(-forward2 * deltaTime);
			cube2.translateX(yaw2 * deltaTime);

			camMove.position.x = (cube.position.x + cube2.position.x) / 20;
			camMove.position.z = (cube.position.z + cube2.position.z) / 20;
			camera.lookAt(camMove.position);


			renderer.render(scene, camera);

			facing1Prev.copy(cube.position);
			//cube.position.copy(facing1Prev);
			//$('#x').text(ex);
			//$('#y').text(sed);
			$('#z').text(angle);
		}

		function setupScene() {
			var visibleSize = { width: window.innerWidth, height: window.innerHeight };
			clock = new THREE.Clock();
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera(75, visibleSize.width / visibleSize.height, 0.1, 100);
			camera.position.z = -10;
			camera.position.y = 10;

			camMove = new THREE.Object3D();
			camMove.position.set(0, 0, 0);
			scene.add(camMove);

			renderer = new THREE.WebGLRenderer({ precision: "mediump" });
			renderer.setClearColor(new THREE.Color(0, 0, 0));
			renderer.setPixelRatio(visibleSize.width / visibleSize.height);
			renderer.setSize(visibleSize.width, visibleSize.height);

			var ambientLight = new THREE.AmbientLight(new THREE.Color(1, 1, 1), 1.0);
			scene.add(ambientLight);

			var directionalLight = new THREE.DirectionalLight(new THREE.Color(1, 1, 0), 0.4);
			directionalLight.position.set(0, 0, 1);
			scene.add(directionalLight);

			var grid = new THREE.GridHelper(50, 10, 0xffffff, 0xffffff);
			grid.position.y = -1;
			scene.add(grid);

			loadOBJWithMTL("modelos/flecha/", "flecha.obj", "flecha2.mtl", (object) => {
				cube = object;
				cube.position.x = 5;
				scene.add(cube);
			});

			loadOBJWithMTL("modelos/flecha/", "flecha.obj", "flecha.mtl", (object) => {
				cube2 = object;
				cube2.position.x = -5;
				scene.add(cube2);
			});

			//posT.copy(cube.position);
			xAxis = new THREE.Vector3(1, 0, 0);
			zAxis = new THREE.Vector3(0, 0, 1);
			facing1Prev = new THREE.Vector3(0, 0, 1);
			facing2Prev = new THREE.Vector3(0, 0, 1);

			$("#scene-section").append(renderer.domElement);
		}

	</script>

	<div id="pauseMenu">
		<div class="center-screen">
			<div class="container">
				<div class="row justify-content-md-center">
					<div class="pauseBTN" onclick="showNoshow()">
						VOLVER AL JUEGO
					</div>
				</div>
				<div class="row justify-content-md-center mt-5">
					<div class="pauseBTN" onclick="redirect('menu.html')">
						SALIR
					</div>
				</div>
				<div class="row"></div>
			</div>

		</div>
	</div>

	<div id="info">
		<p>Datos</p>
		<div>x: <div class="text" id="x"></div>
		</div><br>
		<div>y: <div class="text" id="y"></div>
		</div><br>
		<div>z: <div class="text" id="z"></div>
		</div><br>
		<!--<div>cycle: <div class="text" id="cycle"></div>
		</div><br>
		<div>jumpSpeed: <div class="text" id="jumpSpeed"></div>
		</div><br>
		<div>jump: <div class="text" id="jump"></div>
		</div><br>
		<div>paused: <div class="text" id="inAir"></div>
		</div><br>
		<div>arr[cycle] / 333: <div class="text" id="arr"></div>
		</div><br>-->
	</div>

	<div id="scene-section"></div>
</body>

</html>